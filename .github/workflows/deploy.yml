name: Build and Deploy

on:
  push:
    branches: ['main']
    paths-ignore: # k8s 폴더가 변경될 때는 이 액션을 실행하지 않음 (무한루프 방지)
      - 'k8s/**'

env:
  BACKEND_IMAGE_NAME: savesns-backend_image
  SCRIPTS_IMAGE_NAME: savesns-script-getweather
  SCRIPTS_SHORT_TERM_IMAGE_NAME: savesns-script-getweather-short-term-forecast

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    permissions: # 같은 레포에 푸시하려면 쓰기 권한 필요
      contents: write
    steps:
      - name: Check out code
        uses: actions/checkout@v3

      # [추가] 1. 어디가 바뀌었는지 감지하는 단계
      - uses: dorny/paths-filter@v2
        id: changes
        with:
          filters: |
            backend:
              - 'src/**'
              - 'package.json'
              - 'Dockerfile.backend'
            scripts:
              - 'scripts/weather-ultra-short-term-forecast.py'
              - 'Dockerfile.scripts'\
              - 'scripts/weather-short-term-forecast.py'

      # (Docker 로그인, 빌드, 푸시 단계는 기존과 동일)
      - name: Login to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # [수정] 2. 백엔드 쪽 파일이 변했을 때만('true') 실행
      - name: Build Backend
        if: steps.changes.outputs.backend == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.backend
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}

      # [수정] 3. 스크립트 쪽 파일이 변했을 때만('true') 실행
      - name: Build Scripts
        if: steps.changes.outputs.scripts == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.scripts
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.SCRIPTS_IMAGE_NAME }}:${{ github.sha }}
      - name: Build Scripts Short Term
        if: steps.changes.outputs.scripts == 'true'
        uses: docker/build-push-action@v4
        with:
          context: .
          file: Dockerfile.scripts
          push: true
          tags: ${{ secrets.DOCKER_USERNAME }}/${{ env.SCRIPTS_SHORT_TERM_IMAGE_NAME }}:${{ github.sha }}

      # 핵심: 바로 로컬 파일 수정해서 푸시
      - name: Update Kubernetes Manifest
        run: |
          # 백엔드가 빌드되었을 때만 태그 교체 (if문 사용)
          if [ "${{ steps.changes.outputs.backend }}" == "true" ]; then
            echo "Updating Backend Manifest..."
            sed -i 's|image: .*/${{ env.BACKEND_IMAGE_NAME }}:.*|image: ${{ secrets.DOCKER_USERNAME }}/${{ env.BACKEND_IMAGE_NAME }}:${{ github.sha }}|' k8s/deployment.yaml
          fi

          # 스크립트가 빌드되었을 때만 태그 교체
          if [ "${{ steps.changes.outputs.scripts }}" == "true" ]; then
            echo "Updating Scripts Manifest..."
            sed -i 's|image: .*/${{ env.SCRIPTS_IMAGE_NAME }}:.*|image: ${{ secrets.DOCKER_USERNAME }}/${{ env.SCRIPTS_IMAGE_NAME }}:${{ github.sha }}|' k8s/cronjob.yaml
          fi

          if [ "${{ steps.changes.outputs.scripts }}" == "true" ]; then
            echo "Updating Scripts Short Term Manifest..."
            sed -i 's|image: .*/${{ env.SCRIPTS_SHORT_TERM_IMAGE_NAME }}:.*|image: ${{ secrets.DOCKER_USERNAME }}/${{ env.SCRIPTS_SHORT_TERM_IMAGE_NAME }}:${{ github.sha }}|' k8s/weather-short-term-forecast.yaml
          fi

          git config --global user.email "github-actions@github.com"
          git config --global user.name "GitHub Actions"

          # 변경사항이 있을 때만 커밋 (둘 다 안 바뀌었으면 에러 방지)
          git commit -am "Update image tags [skip ci]" || echo "No changes to commit"
          git push
