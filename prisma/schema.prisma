// DB 연결 설정 (자동으로 생성됨)
generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions", "views"] // PostGIS 등 확장기능 사용 시 필요
}

datasource db {
  provider   = "postgresql"
  extensions = [postgis] // 사용하는 확장기능 명시 (postgis가 설치되어 있어야 함)
}

// ------------------------------------------------------
// 여기서부터 테이블 정의 (User 모델 예시)
// ------------------------------------------------------

/// 회원 계정 정보 (users_account)
model UserAccount {
  userId   String  @id @default(dbgenerated("uuidv7()")) @map("user_id") @db.Uuid
  username String  @unique @db.VarChar(255)
  password String? @db.VarChar(255)
  nickname String? @db.VarChar(255)
  provider String  @default("local") @db.VarChar(255)
  snsId    String? @map("sns_id") @db.VarChar(255)

  // 1:1 관계: 위치 정보
  location UserLocation?

  // 1:N 관계: 작성한 게시글
  posts Post[]

  @@map("users_account")
}

/// 회원 위치 정보 및 기상청 격자 (users_location)
model UserLocation {
  userId    String @id @map("user_id") @db.Uuid
  longitude Float?
  latitude  Float?

  // PostGIS Geometry 타입 (Prisma 미지원 -> Unsupported 처리)
  // DB에서 자동 생성되므로 데이터 삽입 시에는 무시됩니다.
  location Unsupported("geometry(point, 4326)")?

  // Generated Columns (기상청 격자)
  // DB에서 자동 계산되므로 삽입 시 값을 넣지 않습니다.
  nx Int? @db.SmallInt
  ny Int? @db.SmallInt

  // 관계 설정
  user UserAccount @relation(fields: [userId], references: [userId], onDelete: Cascade)

  @@map("users_location")
}

/// 게시글 (posts)
model Post {
  postId    String    @id @default(dbgenerated("uuidv7()")) @map("post_id") @db.Uuid
  userId    String    @map("user_id") @db.Uuid
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)
  contents  String    @db.Text
  longitude Float?
  latitude  Float?

  // Generated Columns (위치)
  location Unsupported("geometry(point, 4326)")?

  // 관계 설정
  user  UserAccount    @relation(fields: [userId], references: [userId], onDelete: Cascade)
  media MediaStorage[]

  @@map("posts")
}

/// 미디어 저장소 (media_storage)
model MediaStorage {
  mediaId   String    @id @default(dbgenerated("uuidv7()")) @map("media_id") @db.Uuid
  link      String?   @db.VarChar
  postId    String    @map("post_id") @db.Uuid
  type      String?   @db.VarChar(20)
  createdAt DateTime? @default(now()) @map("created_at") @db.Timestamp(6)

  // 관계 설정
  post Post @relation(fields: [postId], references: [postId], onDelete: Cascade)

  @@map("media_storage")
}

model WeatherUltraShortTermForecast {
  id           String   @id @default(dbgenerated("uuidv7()")) @map("weather_ultra_short_term_forecast_id") @db.Uuid
  nx           Int      @db.SmallInt
  ny           Int      @db.SmallInt
  baseDatetime DateTime @map("base_datetime") @db.Timestamp(6)
  fcstDatetime DateTime @map("fcst_datetime") @db.Timestamp(6)
  
  // 날씨 데이터 필드들
  t1h Int? @db.SmallInt
  rn1 Int? @db.SmallInt
  sky Int? @db.SmallInt
  uuu Int? @db.SmallInt
  vvv Int? @db.SmallInt
  reh Int? @db.SmallInt
  pty Int? @db.SmallInt
  lgt Int? @db.SmallInt
  vec Int? @db.SmallInt
  wsd Int? @db.SmallInt
  
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamp(6)
  updatedAt DateTime @default(now()) @map("updated_at") @db.Timestamp(6)

  // 복합 유니크 키 설정
  @@unique([nx, ny, fcstDatetime], map: "uq_weather_forecast")
  @@map("weather_ultra_short_term_forecast")
}

// ------------------------------------------------------
// View 정의
// ------------------------------------------------------
view ViewUniqueUserGrid {
  nx Int
  ny Int

  // View는 PK가 없으므로, 유니크한 복합 키로 식별자를 지정해줍니다.
  @@unique([nx, ny])
  @@map("view_unique_user_grids")
}